# Lesson 2.2 - Making Macros

## A Timetable Example

Let's show the use of macros using an example. You can download the example [here](https://canvas.ust.hk/courses/44418/files/6294531/download?wrap=1 "01_timetable_unformatted.xlsx").

We start with this worksheet.
![[Pasted image 20220714014856.png]]
The worksheet contains the timetable of a student. The timetable is complete and correct but the cells look very boring and unattractive. Let's use macros to make them look nicer!

## Making Your First Macro

Let's choose to make all the CHEM1202 cells nicer first. We will make a macro which can then be used to apply exactly the same visual formatting to each of the CHEM1202 cells. To get started let's select one of the three CHEM1202 cells in the worksheet.

We will now create a macro which will work on any cell (specifically, the cell which is currently selected). To do that, let's look again at the _Developer_ tab in the ribbon.

![[Pasted image 20220714014910.png]]
First, you have to make sure _Use Relative References_ is selected like this:
![[Pasted image 20220714014921.png]]
Then you can start to record your macro by clicking on the _Record Macro_ button, which you can see directly above the _Use Relative References_ option. After clicking on the button you will see the following window.
![[Pasted image 20220714014930.png]]
What you can do here is to set up your macro. For example, if you want to you can adjust the name of the VBA function that will be created for your macro (as you can see in the above image, the default name is _Macro1_). You can also tell Excel which shortcut key you want to press to run the macro. For instance, you can tell Excel to run your Macro whenever you press _Ctrl_ and _M_. For the macro you are going to create now, let's simply press _OK_ to use the default values. You can always come back and change them later.

After you press _OK_, from now onwards everything you do inside Excel is recorded. Now let's do whatever formatting we want to apply to the CHEM1202 cell. For example:

-   Set the background colour
-   Set the text colour
-   Center the text in the x axis
-   Center the text in the y axis
![[Pasted image 20220714014941.png]]
These formatting are just examples - you can do as many things to the cell as you like! After finishing formatting the cell, you can stop the recording process by selecting the _Stop Recording_ button. The button is in the same place as the _Record Macro_ button, as shown by the orange box below.
![[Pasted image 20220714014950.png]]
You have now finished making the Macro! In the next part we will use the macro to format all CHEM1202 cells.

## VBA Code Created for the Macro

When you made the macro in the previous page you did not need to write any VBA code. Before trying to use the macro it would be a good idea to check the content of the VBA code that was just created.

To do that, click on the _Macros_ button on the _Developer_ tab, select the macro you have just created in the _Macro Window_ (shown below), and then click on the _Edit_ button, like this:

![[Pasted image 20220714015011.png]]
Once you have clicked on the _Edit_ button, you will see the VBA code of your macro shown in the VBA editor:
![[Pasted image 20220714015028.png]]
Here is the code shown in the editor:

Sub Macro1()
'
' Macro1 Macro
'

'
    With Selection.Interior
        .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .Color = 65535
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    With Selection.Font
        .ThemeColor = xlThemeColorAccent1
        .TintAndShade = 0
    End With
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlTop
        .WrapText = True
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = True
    End With
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .WrapText = True
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = True
    End With
End Sub

Let's briefly explain the VBA code shown above. A macro is stored as a _subroutine_ in VBA:

Sub Macro1()

A _subroutine_ in VBA is similar to a function in other programming languages. We will talk more about this later in the course.

Returning to the code, the first few lines of the subroutine:

'
' Macro1 Macro
' 

'

are comments. You write comments in VBA code by putting a single quote (') at the start of the line. The comments shown above are generated by Excel and they don't say anything useful! You can delete them or change them, as you wish.

The rest of the code shows the four stages of formatting we have done in the example, i.e. changing background colour, changing font colour, and so on. Each of the formatting stages is created (by Excel) inside a _With_ block, like this:

With Selection.Interior
    ... Change the background colour ...
End With
With Selection.Font
    ... Change the font colour ...
End With
With Selection
    ... Change the horizontal alignment ...
End With
With Selection
    ... Change the vertical alignment ...
End With

Clearly the macro VBA code shown above reflects the four things that we did by clicking on buttons in the Excel GUI when we recorded the macro. If you have done this yourself and applied different formatting to your cell then you will see slightly different VBA code for your macro. At this stage you don't need to understand the VBA code in great detail, although you can probably see that some of it is easy to understand. We will look at some of these lines of code later in the course.

## Applying the Macro

Now you can apply the macro to all cells of the course CHEM1202. For each cell to which you want to apply the macro, click on the cell, then run the macro by clicking on the _Run_ button in the _Macro_ window, as shown in the picture below (remember you can open the _Macro_ window by clicking on the _Macros_ button in the _Developer_ tab).
![[Pasted image 20220714015059.png]]
Alternatively, you can run the macro using a shortcut key (if you previously set one in the macro options). You can download an example [here](https://canvas.ust.hk/courses/44418/files/6294037/download?wrap=1 "02_timetable_one_course_formatted.xlsm")  which uses the shortcut key _Ctrl-I_ to run the macro in the Excel file. (There is only one macro in this example Excel file).

Here is the result after applying the macro to the two other cells containing CHEM1202 in the timetable worksheet.
![[Pasted image 20220714015109.png]]
In the same way you can make four more macros to format the other courses, and then apply them to the appropriate cells. The result can look something like this:
![[Pasted image 20220714015125.png]]
## Creating Macros Using the VBA Editor

How to create the other four macros for the other courses? One straightforward way is to use the macro recorder four more times.

A more clever way is by using VBA code, like this:

-   In the VBA editor, copy the macro code that already exists (by highlighting the code with your mouse and then doing _Ctrl-C_)
-   Paste the code underneath the current macro code by clicking at the appropriate place in the VBA editor and doing _Ctrl-V_
-   Change the name of the macro code you just pasted, because each _Sub_ must have a name which is not used anywhere else
-   Change some of the macro code you just pasted to make the macro apply a different colour, or a different format, and so on. You can do this by simply clicking on the line of code you want to change and then amending it.

Let's look at this using our timetable example.

At the moment you should have your CHEM1202 macro working in your Excel file. Let's say the next course you want to format is COMP2101. Instead of recording a new macro all over again you can make use of the VBA code of the CHEM1202 macro.

First, similar to what you have done before, open the VBA code of the CHEM1202 macro by going to the _Macro Window_, selecting the CHEM1202 macro and clicking on the _Edit_ button. The VBA code of the macro will be shown in the VBA editor, like this:
![[Pasted image 20220714015143.png]]
Then select the macro subroutine, such as _Macro1()_, in the VBA editor, and press _Ctrl-C_ to copy it, like this:
![[Pasted image 20220714015156.png]]
Then select an appropriate place, such as underneath the current macro code, and paste the copied macro by pressing _Ctrl-V_. You will have two identical copies of the macro in the VBA editor, like this:
![[Pasted image 20220714015208.png]]
Since you cannot have two macros using the same name you need to give the new macro a new name. For instance, you can call it _Macro2_COMP2101_. The first line of the subroutine then becomes:

Sub Macro2_COMP2101()

It is very helpful to have a meaningful name for your macro, so let's change the name of the CHEM1202 macro too! For example, you can change it to _Macro1_CHEM1202_.

What do you have now? You have two subroutines in your VBA editor with different names but identical code. The intention is not to have exactly the same things being applied by the two macros. You need to adjust the code of the new macro _Macro2_COMP2101_ so that it will do what you want. Remember there are four formatting stages in our example. We can modify some of these for the new macro. For example, the background colour and font colour can be easily changed.

Let's change the background colour. First, locate this code in the new macro subroutine:

With Selection.Interior
    .Pattern = xlSolid
    .PatternColorIndex = xlAutomatic
    .Color = 65535
    .TintAndShade = 0
    .PatternTintAndShade = 0
End With

You can change the colour of the background by changing this line:

.Color = 65535

so that another colour value is used (a number in the range 0 to 65535).

To change the font colour you can locate this code:

With Selection.Font
    .ThemeColor = xlThemeColorAccent1
    .TintAndShade = 0
End With

You can change the colour of the font by changing this line:

.ThemeColor = xlThemeColorAccent1

by changing **xlThemeColorAccent1** into **xlThemeColorAccent2** or **xlThemeColorAccent3**, or any other number up to 6.

In our example five macros, including the CHEM1202 macro, have been created for the courses in the timetable (one macro for each course), as shown below:
![[Pasted image 20220714015233.png]]
You can download the completed example [here](https://canvas.ust.hk/courses/44418/files/6294477/download?wrap=1 "03_timetable_all_courses_formatted.xlsm") . These macros are created by copying and pasting from the existing macro. Each macro has been given an appropriate name shown in the VBA code. After applying the macros the timetable looks like this:
![[Pasted image 20220714015247.png]]